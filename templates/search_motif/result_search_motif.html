{% extends '_base.html' %} {% load static %} 
{% block title %}Search For
CARE{%endblock title %} {% block content %}
<h2>Result Search For CARE</h2>
<div class="checkbox-container">
  <label>
    <input type="checkbox" id="toggle-reverse" /> Show Reverse Sequence
  </label>
</div>

<div class="result_sequences">
  <div class="result-seq-container">
    <div class="result-seq">
      <h3>Fragment result:</h3>
      <div id="dna-output" class="dna-container"></div>
    </div>
    <div class="column">
      <h3>Motif found in sequence to submit</h3>
      <button id="export-csv-button">Export CSV</button>
      <form
        id="export-csv-form"
        action="{% url 'export_csv' %}"
        method="get"
        style="display: none"
      ></form>
      {% for i in motif_found %}
      <p>
        <a href="#" class="motif-link" data-seq="{{ i.sq }}">{{ i.ac }}</a>:
        <span
          class="highlight motif"
          data-id="{{ i.sq }}"
          style="background-color: {{i.color}}; color:white; padding-right: 8px; padding-left: 8px;"
          >{{ i.sq }}</span
        >
        <div class="motif-details" id="details-{{ i.sq }}" style="display: none;">
          <p>Short description: {{ i.de }}</p>
          <p>Organism: {{ i.os }}</p>
        </div>
      </p>
      {% endfor %}
    </div>
  </div>
</div>

<div class="result_sequences">
  <div class="result-seq-container">
    <div class="reverse-dna-container result-seq" style="display: none">
      <h3>Reverse fragment results</h3>
      <div id="reverse-dna-output" class="dna-container"></div>
    </div>

    <div class="column" id="result-reverse" style="display: none">
      <h3>Motif found in sequence_reverse to submit</h3>
      <button id="export-rev-csv-button">Export CSV</button>
      <form
        id="export-rev-csv-form"
        action="{% url 'export_rev_csv' %}"
        method="get"
        style="display: none"
      ></form>
      {% for i in reverse_motif_found %}
      <p>
        <a href="#" class="motif-link" data-seq="{{ i.sq }}">{{ i.ac }}</a>:
        <span
          class="highlight motif"
          data-id="{{ i.sq }}"
          style="background-color: {{i.color}}; color:white; padding-right: 8px; padding-left: 8px;"
          >{{ i.sq }}</span
        >
      </p>
      {% endfor %}
    </div>
  </div>
</div>

{% comment %}
<p>{{ motif_found }}</p>
{% endcomment %}

<!-- {% for factor in motif_found %}
      <p><a href="{{ searchforcare.get_absolute_url }}">{{factor}}</a></p>
  {% endfor %}
      <h3><a href="{{ factor.get_absolute_url }}">{{ factor.ac }}</a></h3>
      <p>AC: {{ factor.ac }}</p>
      <p>DT: {{ factor.dt }}</p>
      <p>RD: {{ factor.rd }}</p>  -->
{% comment %}
<p>{{ reverse_motif_found }}</p>
{% endcomment %}

<script>
  function convertDnaStringToList(dna) {
    const tempDiv = document.createElement("div");
    tempDiv.innerHTML = dna;

    const dnaList = [];

    Array.from(tempDiv.childNodes).forEach((node) => {
      if (node.nodeType === Node.TEXT_NODE) {
        dnaList.push(...node.textContent.split(""));
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        dnaList.push(node.outerHTML);
      }
    });

    return dnaList;
  }

  function formatDnaSequence(dna) {
    let formattedSequence = "";
    const chunkSize = 10;
    const lineSize = 7;
    let i = 0;

    while (i < dna.length) {
      let lineChunks = [];
      for (let j = 0; j < lineSize && i < dna.length; j++) {
        let chunk = dna.slice(i, i + chunkSize).join("");
        lineChunks.push(chunk);
        i += chunkSize;
      }
      formattedSequence +=
        '<div class="dna-line">' + lineChunks.join("&nbsp;") + "</div>";
    }

    return formattedSequence;
  }

  function toggleHighlight(motifId) {
    const motifElements = document.querySelectorAll(
      `.motif[data-id="${motifId}"]`
    );
    motifElements.forEach((element) => {
      element.classList.toggle("active");
    });
  }

  function toggleHighlightAndDetails(motifId) {
    const motifElements = document.querySelectorAll(`.motif[data-id="${motifId}"]`);
    motifElements.forEach(element => {
      element.classList.toggle("active");
    });
  
    const detailsElement = document.getElementById(`details-${motifId}`);
    if (detailsElement) {
      detailsElement.style.display = detailsElement.style.display === 'none' ? 'block' : 'none';
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    const dnaSequence = "{{ fragment|escapejs }}";
    const reverseDnaSequence = "{{ reverse_fragment|escapejs }}";

    const dnaList = convertDnaStringToList(dnaSequence);
    const reverseDnaList = convertDnaStringToList(reverseDnaSequence);

    const formattedDna = formatDnaSequence(dnaList);
    const formattedReverseDna = formatDnaSequence(reverseDnaList);

    document.getElementById("dna-output").innerHTML = formattedDna;
    document.getElementById("reverse-dna-output").innerHTML =
      formattedReverseDna;

    const toggleReverseCheckbox = document.getElementById("toggle-reverse");
    const reverseDnaContainer = document.querySelector(
      ".reverse-dna-container"
    );
    const reverseResultContainer = document.getElementById("result-reverse");

    toggleReverseCheckbox.addEventListener("change", function () {
      if (this.checked) {
        reverseDnaContainer.style.display = "contents";
        reverseResultContainer.style.display = "block";
      } else {
        reverseDnaContainer.style.display = "none";
        reverseResultContainer.style.display = "none";
      }
    });

    document.querySelectorAll(".motif-link").forEach((link) => {
      link.addEventListener("click", function (event) {
        event.preventDefault();
        const motifId = this.dataset.seq;
        toggleHighlightAndDetails(motifId);
      });
    });

    document
      .getElementById("export-csv-button")
      .addEventListener("click", function () {
        document.getElementById("export-csv-form").submit();
      });

    document
      .getElementById("export-rev-csv-button")
      .addEventListener("click", function () {
        document.getElementById("export-rev-csv-form").submit();
      });

    document.querySelectorAll(".motif").forEach((motif) => {
      motif.addEventListener("click", function () {
        toggleHighlightAndDetails(this.dataset.id);
      });
    });
  });
</script>

<style>
  .motif {
    color: black; /* Màu chữ mặc định */
    background-color: transparent; /* Mặc định không có màu nền */
  }

  .motif.active {
    color: white; /* Màu chữ khi được kích hoạt */
    background-color: var(--motif-color); /* Màu nền khi được kích hoạt */
  }

  .result-seq-container {
    display: flex;
  }

  .result-seq {
    display: flex;
    flex-direction: column;
    margin-right: 20px;
  }

  .motif-details {
    margin-top: 10px;
    background-color: #f9f9f9;
    padding: 10px;
    border: 1px solid #ccc;
  }
</style>

{% endblock content %}
